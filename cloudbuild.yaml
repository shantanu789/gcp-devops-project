options:
  logging: CLOUD_LOGGING_ONLY

steps:
  # 1. Build Docker image - fixing Docker API version
  - name: 'docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        export DOCKER_API_VERSION=1.41
        docker build -t us-central1-docker.pkg.dev/$PROJECT_ID/gcp-devops-project/my-app:$SHORT_SHA .

  # 2. Push the image to Artifact Registry
  - name: 'docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        export DOCKER_API_VERSION=1.41
        docker push us-central1-docker.pkg.dev/$PROJECT_ID/gcp-devops-project/my-app:$SHORT_SHA

  # 3. Deploy to GKE
  - name: "gke-deploy"
    args:
      - "--cluster=k8s-devops"
      - "--location=us-central1-a"
      - "--manifest=gke-app.yaml"
      - "--image=us-central1-docker.pkg.dev/$PROJECT_ID/gcp-devops-project/my-app:$SHORT_SHA"
      - "--namespace=gcp-devops-prod"

images:
  - "us-central1-docker.pkg.dev/$PROJECT_ID/gcp-devops-project/my-app:$SHORT_SHA"